<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Space Shuttle Reentry" href="ReentryExample.html" /><link rel="prev" title="Examples" href="examples.html" />

    <!-- Generated with Sphinx 6.2.1 and Furo 2023.05.20 -->
        <title>Delta 3 Multi-phase GTO Transfer - ASSET 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">ASSET 0.2.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/ASSETLOGO.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">ASSET 0.2.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/Install.html">Installing ASSET</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/VectorFunctionGuide.html">Vector Function Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/ODEGuide.html">ODE Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/IntegratorGuide.html">Integrator Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/PhaseGuide.html">Optimal Control Phase Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/OptimalControlProblem.html">Optimal Control Problem Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/PSIOPT.html">PSIOPT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/AutoMeshGuide.html">Adaptive Mesh Refinement Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/OptimalControlUtilites.html">Optimal Control Utilities</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="examples.html">Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Delta 3 Multi-phase GTO Transfer</a></li>
<li class="toctree-l2"><a class="reference internal" href="ReentryExample.html">Space Shuttle Reentry</a></li>
<li class="toctree-l2"><a class="reference internal" href="CartPole.html">Cart-Pole Swing Up</a></li>
<li class="toctree-l2"><a class="reference internal" href="HyperSensitive.html">Hyper-Sensitive Optimal Control Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="halo.html">Orbit Family Continuation</a></li>
<li class="toctree-l2"><a class="reference internal" href="zermelo.html">Zermelo’s Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="zermelolink.html">Multi-Phase Zermelo’s Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="MultiTarg.html">Multi-Spacecraft Optimization</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../python/python.html">Python Library Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Python Library Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../python/asset.html">ASSET</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python/optimalcontrol.html">Optimal Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python/vectorfunctions.html">Vector Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python/Astro.html">ASSET Astro Library</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="delta-3-multi-phase-gto-transfer">
<h1>Delta 3 Multi-phase GTO Transfer<a class="headerlink" href="#delta-3-multi-phase-gto-transfer" title="Permalink to this heading">#</a></h1>
<figure class="align-right" id="id1">
<a class="reference internal image-reference" href="../_images/Delta_III.svg"><img alt="../_images/Delta_III.svg" src="../_images/Delta_III.svg" width="70%" /></a>
<figcaption>
<p><span class="caption-text">Delta 3 Rocket.</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
<div class="legend">
<p>Courtesy W. D. Graham.</p>
</div>
</figcaption>
</figure>
<p>As an example of a multi-phase optimal control problem, we will optimize the launch and
geostationary transfer orbit insertion of a Delta 3 rocket as described by Betts in [1].</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We should note that this example is derived entirely from publicly available sources (see [1-4]). Furthermore, this problem is routinely
used [1-4] as a benchmark for generic multi-phase optimal control packages such as ASSET.</p>
</div>
<p>The Delta 3 was nominally a 2 stage rocket consisting of a first stage RS-27A and 9 solid rocket boosters topped with an RL-10 upper stage. The rocket had an interesting staging
strategy with the first stage liquid engine and only 6 of the 9 SRBs igniting at take off. Following burnout of these 6 solid rocket
boosters 75.2 seconds after launch, the inert mass is ejected and the remaining 3 boosters are ignited. After another 75.2 seconds (t+150.4s) these 3 SRBs
too are ejected and the first stage continues to burn until t+261s.
At this point the RL-10 upper stage and payload separate from the first stage and continue to orbit, burning for up to an additional 700 seconds.</p>
<p>Betts’ problem in [1] involves maximizing the mass delivered to a pre-specified geostationary orbit for a launch from cape Canaveral.
This problem can be broken down into 4 phases:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>6 SRBs + First Stage   (  0.0  &lt;= t &lt;=  75.2s)</p></li>
<li><p>3 SRBs + First Stage   ( 75.2s &lt;= t &lt;= 150.4s)</p></li>
<li><p>First Stage            (150.4s &lt;= t &lt;= 261.0s)</p></li>
<li><p>Second Stage.          (261.0s &lt;= t &lt;= 961.0s)</p></li>
</ol>
</div></blockquote>
<p>The dynamics on each of the four phases are expressed in Cartesian coordinates
and are all the same save for differing values for the combined thrust and mass flow-rate of the currently burning engine configurations.
The thrust (<span class="math notranslate nohighlight">\(T_i\)</span>) , and mass flow rate (<span class="math notranslate nohighlight">\(\dot{m}_i\)</span>), and inert masses for stages can be found in [1] and in our example script.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\dot{\vec{r}} &amp;= \vec{v}\\\dot{\vec{v}} &amp;= -\frac{\mu}{r^3}\vec{r} +  \frac{T_i\hat{u} + \vec{D}}{m}\\\dot{m}       &amp;= -\dot{m}_i\end{aligned}\end{align} \]</div>
</div>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\vec{D} &amp;= \frac{1}{2}C_D S \rho |\vec{v}_r|\vec{v_r}\\\vec{v}_r &amp;= \vec{v} + \vec{r}\times\vec{\omega}_e\\\rho  &amp;= \rho_0 e^{-h/h_0}\\h  &amp;= |\vec{r}| - R_e\end{aligned}\end{align} \]</div>
</div>
<p>Initial conditions applied to the first phase enforce that the rocket depart from the Cape’s latitude
with zero velocity relative to the surface of the Earth.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\vec{r}(0) &amp;= [\cos(28.5^\circ),0,\sin(28.5^\circ)]^T\\\vec{v}(0) &amp;= -\vec{r}\times\vec{\omega}_e\end{aligned}\end{align} \]</div>
</div>
<p>Terminal conditions applied to the final phase enforce that the rocket
insert into a geostationary transfer orbit with the following classical orbital elements.</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}a(t_f) &amp;= 24361140 \;km\\e(t_f) &amp;= .7308\\i(t_f) &amp;= 28.5^\circ\\\omega(t_f) &amp;= 130.5 ^\circ\\\Omega(t_f) &amp;= 269.8 ^\circ\end{aligned}\end{align} \]</div>
</div>
<p>Modeling this problem in ASSET starts with defining the dynamics for each phase. Since the structure of the dynamics is the same for
all 4 phases, we can model them with a single ASSET ODE given below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RocketODE</span><span class="p">(</span><span class="n">oc</span><span class="o">.</span><span class="n">ODEBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">mdot</span><span class="p">):</span>
        <span class="c1">####################################################</span>
        <span class="n">XtU</span>  <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">ODEArguments</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVec</span><span class="p">()</span><span class="o">.</span><span class="n">head3</span><span class="p">()</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVec</span><span class="p">()</span><span class="o">.</span><span class="n">segment3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># We normalize the control direction in the dynamics so it doesnt have</span>
        <span class="c1"># to be done as a path constraint</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">UVec</span><span class="p">()</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>

        <span class="n">h</span>       <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">-</span> <span class="n">Re</span>
        <span class="n">rho</span>     <span class="o">=</span> <span class="n">RhoAir</span> <span class="o">*</span> <span class="n">vf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">h</span> <span class="o">/</span> <span class="n">h_scale</span><span class="p">)</span>
        <span class="n">Vr</span>      <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">We</span><span class="p">]))</span>

        <span class="c1">## We cant let let Vr be exactly 0, derivative of norm of 0 vector is NAN</span>
        <span class="c1">## Will handle this in inititial conditions</span>
        <span class="n">D</span>       <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">CD</span><span class="o">*</span><span class="n">S</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">Vr</span><span class="o">*</span><span class="n">Vr</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>

        <span class="n">Rdot</span>    <span class="o">=</span>  <span class="n">V</span>
        <span class="n">Vdot</span>    <span class="o">=</span>  <span class="p">(</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">R</span><span class="o">.</span><span class="n">normalized_power3</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span><span class="o">/</span><span class="n">m</span>

        <span class="n">ode</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">Rdot</span><span class="p">,</span><span class="n">Vdot</span><span class="p">,</span><span class="o">-</span><span class="n">mdot</span><span class="p">)</span>
        <span class="c1">####################################################</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>As you might have noticed, our model is written in Cartesian coordinates, but our terminal boundary conditions on the final phase are given
as a set of classical orbital elements. This necessitates writing a custom constraint (below), which will convert from Cartesian coordinates to
orbital elements so that we can target the given orbit. Those familiar with this conversion will know that it requires quadrant checks on the RAAN
and argument of periapse, and thus requires a run-time conditional statement. Such simple conditional statements can be readily handled in ASSET’s VectorFunction type system,
using the <code class="code docutils literal notranslate"><span class="pre">vf.ifelse</span></code> function as seen below. The first argument of the function is a conditional statement containing at least one ASSET VectorFunction.
At run time, if this statement, evaluates to True, output of the function will be given by the second argument,
and if it evaluates to <code class="code docutils literal notranslate"><span class="pre">False</span></code> , the output will be the final argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">TargetOrbit</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">):</span>
    <span class="n">R</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)])</span>

    <span class="n">r</span>    <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="n">v</span>    <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="c1">#Angular momentum vector</span>
    <span class="n">hvec</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1">#Node vector</span>
    <span class="n">nvec</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">cross</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">hvec</span><span class="p">)</span>

    <span class="c1"># Energy</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="o">/</span><span class="n">r</span>

    <span class="c1"># Semi-major axis</span>
    <span class="n">a</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span><span class="o">/</span><span class="n">eps</span>

    <span class="n">evec</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">hvec</span><span class="p">)</span><span class="o">/</span><span class="n">mu</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
    <span class="c1">#Eccentrcity</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">evec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="c1">#inclination</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">hvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1">#RAAN</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">nvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Quadrant Check</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="n">nvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span><span class="n">O</span><span class="p">)</span>

    <span class="c1"># Argument of periapse</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">nvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()))</span>
    <span class="c1">#QuadrantCheck</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="n">evec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">W</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">W</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">])</span>
</pre></div>
</div>
<p>With our dynamics and custom boundary constraint defined we can now begin the task of setting up and solving the problem.</p>
<p>Our first step here will be to find a suitable initial guess for all four phases of the rockets flight as shown below. To do this, we adopt a similar
strategy to Betts of selecting a state along the target orbit, and linearly interpolating from our known initial conditions. We roughly select this terminal state
such that the linearly interpolated initial guess departs the cape in an easterly direction and does not pass under the surface of the Earth.
This initial guess is evenly partitioned in time to construct the position and velocity along each phase.
Because the dynamics do not allow throttling of the engine, we can also supply the exact mass history for each phase.
The thrust directions are arbitrarily set to the unit y direction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Target orbital elements</span>
<span class="n">at</span>     <span class="o">=</span> <span class="mi">24361140</span> <span class="o">/</span><span class="n">Lstar</span>
<span class="n">et</span>     <span class="o">=</span> <span class="mf">.7308</span>
<span class="n">Ot</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">269.8</span><span class="p">)</span>
<span class="n">Wt</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">130.5</span><span class="p">)</span>
<span class="n">istart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">28.5</span><span class="p">)</span>


<span class="n">y0</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">))</span>
<span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">istart</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">istart</span><span class="p">)])</span><span class="o">*</span><span class="n">Re</span>
<span class="n">y0</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">We</span><span class="p">]))</span>
<span class="n">y0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">+=</span> <span class="mf">0.00001</span><span class="o">/</span><span class="n">Vstar</span>  <span class="c1"># cant be exactly zero,our drag equation&#39;s derivative would NAN !!!</span>


<span class="c1">## MF is the only magic number in the script, just trying to find</span>
<span class="c1">## a mean anomaly such that the terminal state on the orbit is downrange</span>
<span class="c1">## eastward from KSC in and doesnt pass through earth when LERPed from KSC</span>
<span class="n">MF</span>   <span class="o">=-</span><span class="mf">.05</span>
<span class="n">OEF</span>  <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">MF</span><span class="p">]</span>
<span class="n">yf</span>   <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Astro</span><span class="o">.</span><span class="n">classic_to_cartesian</span><span class="p">(</span><span class="n">OEF</span><span class="p">,</span><span class="n">mu</span><span class="p">)</span>

<span class="n">ts</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tf_phase4</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">IG1</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">IG2</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">IG3</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">IG4</span> <span class="o">=</span><span class="p">[]</span>


<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">11</span><span class="p">))</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">yf</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="n">t</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase1</span><span class="p">):</span>
        <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase1</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase1</span><span class="o">-</span><span class="n">m0_phase1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tf_phase1</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
        <span class="n">IG1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase2</span><span class="p">):</span>
        <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase2</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase2</span><span class="o">-</span><span class="n">m0_phase2</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase2</span> <span class="o">-</span> <span class="n">tf_phase1</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
        <span class="n">IG2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase3</span><span class="p">):</span>
        <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase3</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase3</span><span class="o">-</span><span class="n">m0_phase3</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase3</span> <span class="o">-</span> <span class="n">tf_phase2</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
        <span class="n">IG3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase4</span><span class="p">):</span>
        <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase4</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase4</span><span class="o">-</span><span class="n">m0_phase4</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase4</span> <span class="o">-</span> <span class="n">tf_phase3</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
        <span class="n">IG4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can instantiate (below), the ODE’s and phases for each of the 4 rocket stages and combine them into a single optimal control problem.
On the first phase we apply our known initial state, time, and mass as a boundary value. The length of the phase is then enforced by fixing the
final time of the last state to be equal to the burnout time of the first 6 SRB’s.
The initial position, velocity, and time of phases 2 and 3 will be dictated by later continuity constraints,
so along these phases we only need to explicitly enforce the known initial mass and burnout times given in the problem statement.
In <code class="code docutils literal notranslate"><span class="pre">phase4</span></code>, since the final burnout time of the final stage is not known, we simply place the upper bound to be the time at which all propellant would have been expended.
Additionally, it is to this phase that we apply our terminal constraint on the target orbit, and our objective to maximize final mass.</p>
<p>Finally, we combine these 4 phases into a single optimal control problem and add a link constraint that enforces position, velocity,
and time continuity between sequential phases.
We then run <code class="code docutils literal notranslate"><span class="pre">solve_optimize()</span></code> on the problem with the line search enabled and return the solution for plotting.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ode1</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase1</span><span class="p">,</span><span class="n">mdot_phase1</span><span class="p">)</span>
<span class="n">ode2</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase2</span><span class="p">,</span><span class="n">mdot_phase2</span><span class="p">)</span>
<span class="n">ode3</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase3</span><span class="p">,</span><span class="n">mdot_phase3</span><span class="p">)</span>
<span class="n">ode4</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase4</span><span class="p">,</span><span class="n">mdot_phase4</span><span class="p">)</span>

<span class="n">tmode</span> <span class="o">=</span> <span class="s2">&quot;LGL3&quot;</span>
<span class="n">cmode</span> <span class="o">=</span> <span class="s2">&quot;HighestOrderSpline&quot;</span>

<span class="n">nsegs1</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">nsegs2</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">nsegs3</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">nsegs4</span> <span class="o">=</span> <span class="mi">40</span>

<span class="c1">#########################################</span>
<span class="n">phase1</span> <span class="o">=</span> <span class="n">ode1</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG1</span><span class="p">,</span><span class="n">nsegs1</span><span class="p">)</span>
<span class="n">phase1</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

<span class="c1">## Thrust direction is normalized in dynamics, so we dont</span>
<span class="c1">## have to enforce norm of 1 on controls. For good measure,</span>
<span class="c1">## we do bound the magnitude to prevent it from becoming too large or small</span>
<span class="n">phase1</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">phase1</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">IG1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>

<span class="c1">#Dont want our bound to interfere with initial condition which starts at Re</span>
<span class="c1">#so i relax the Earth radius constraint slightly here</span>
<span class="n">phase1</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="o">*</span><span class="mf">.999999</span><span class="p">)</span>
<span class="n">phase1</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,[</span><span class="mi">7</span><span class="p">],[</span><span class="n">tf_phase1</span><span class="p">])</span>

<span class="c1">#########################################</span>
<span class="n">phase2</span> <span class="o">=</span> <span class="n">ode2</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG2</span><span class="p">,</span><span class="n">nsegs2</span><span class="p">)</span>
<span class="n">phase2</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

<span class="n">phase2</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
<span class="n">phase2</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1">## Fixing initial mass and final time on first 3 phases.</span>
<span class="c1">## Since the engine cant be throttled, constraining final mass</span>
<span class="c1">## as well would be redundant and over-constrained</span>
<span class="n">phase2</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase2</span><span class="p">])</span>
<span class="n">phase2</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">,[</span><span class="n">tf_phase2</span><span class="p">])</span>

<span class="c1">#########################################</span>
<span class="n">phase3</span> <span class="o">=</span> <span class="n">ode3</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG3</span><span class="p">,</span><span class="n">nsegs3</span><span class="p">)</span>
<span class="n">phase3</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

<span class="n">phase3</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
<span class="n">phase3</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">phase3</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase3</span><span class="p">])</span>
<span class="n">phase3</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">,[</span><span class="n">tf_phase3</span><span class="p">])</span>

<span class="c1">#########################################</span>
<span class="n">phase4</span> <span class="o">=</span> <span class="n">ode4</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG4</span><span class="p">,</span><span class="n">nsegs4</span><span class="p">)</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

<span class="n">phase4</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase4</span><span class="p">])</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">addUpperVarBound</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">tf_phase4</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">addEqualCon</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="n">TargetOrbit</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="c1"># Maximize final mass</span>
<span class="n">phase4</span><span class="o">.</span><span class="n">addValueObjective</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1">#########################################</span>

<span class="n">ocp</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">OptimalControlProblem</span><span class="p">()</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase1</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase2</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase3</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase4</span><span class="p">)</span>

<span class="c1">## All phases continuous in everything but mass (var 6)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">addForwardLinkEqualCon</span><span class="p">(</span><span class="n">phase1</span><span class="p">,</span><span class="n">phase4</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>


<span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_OptLSMode</span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_SoeLSMode</span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_MaxLSIters</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_PrintLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ocp</span><span class="o">.</span><span class="n">solve_optimize</span><span class="p">()</span>


<span class="n">Phase1Traj</span> <span class="o">=</span> <span class="n">phase1</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>  <span class="c1"># or ocp.Phase(i).returnTraj()</span>
<span class="n">Phase2Traj</span> <span class="o">=</span> <span class="n">phase2</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>
<span class="n">Phase3Traj</span> <span class="o">=</span> <span class="n">phase3</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>
<span class="n">Phase4Traj</span> <span class="o">=</span> <span class="n">phase4</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final Mass = &quot;</span><span class="p">,</span><span class="n">Phase4Traj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">Mstar</span><span class="p">,</span><span class="s1">&#39; kg&#39;</span><span class="p">)</span>

<span class="n">Plot</span><span class="p">(</span><span class="n">Phase1Traj</span><span class="p">,</span><span class="n">Phase2Traj</span><span class="p">,</span><span class="n">Phase3Traj</span><span class="p">,</span><span class="n">Phase4Traj</span><span class="p">)</span>
</pre></div>
</div>
<p>On an intel i9-12900k ,using 160 LGL3 segments across all 4 phases, this problem solves in approximately 60 milliseconds.
The altitude, velocity and mass of the rocket as function of time are plotted below along with a ground-track of the trajectory.
Final Mass Delivered to the GTO is 7529.749kg, which is effectively the same as that given by Betts (7529.712 kg).</p>
<a class="reference internal image-reference" href="../_images/Delta3.svg"><img alt="../_images/Delta3.svg" src="../_images/Delta3.svg" width="100%" /></a>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Betts, J.T. “Practical methods for Optimal Control and Estimation Using Nonlinear Programming”, Cambridge University Press, 2009</p></li>
<li><p>Agamawi, Y. M., &amp; Rao, A. V. (2020). Cgpops: A c++ software for solving multiple-phase optimal control problems using adaptive gaussian quadrature collocation and sparse nonlinear programming. ACM Transactions on Mathematical Software (TOMS), 46(3), 1-38.</p></li>
<li><p>Patterson, M. A., &amp; Rao, A. V. (2014). GPOPS-II: A MATLAB software for solving multiple-phase optimal control problems using hp-adaptive Gaussian quadrature collocation methods and sparse nonlinear programming. ACM Transactions on Mathematical Software (TOMS), 41(1), 1-37.</p></li>
<li><p>Benson, D. (2005). A Gauss pseudospectral transcription for optimal control (Doctoral dissertation, Massachusetts Institute of Technology).</p></li>
</ol>
</section>
<section id="full-code">
<h2>Full Code<a class="headerlink" href="#full-code" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">asset_asrl</span> <span class="k">as</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span> <span class="c1">## PIP INSTALL Basemap if you dont have it</span>

<span class="n">vf</span>        <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">VectorFunctions</span>
<span class="n">oc</span>        <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">OptimalControl</span>
<span class="n">Args</span>      <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">Arguments</span>

<span class="c1">############################################################################</span>

<span class="n">g0</span>      <span class="o">=</span>  <span class="mf">9.80665</span>
<span class="n">Lstar</span>   <span class="o">=</span>  <span class="mi">6378145</span>           <span class="c1">## m   Radius of Earth</span>
<span class="n">Tstar</span>   <span class="o">=</span>  <span class="mf">961.0</span>             <span class="c1">## sec Engine Burn Time</span>
<span class="n">Mstar</span>   <span class="o">=</span>  <span class="mf">301454.0</span>          <span class="c1">## kgs Inital Mass of Rocket</span>


<span class="n">Astar</span>   <span class="o">=</span>  <span class="n">Lstar</span><span class="o">/</span><span class="n">Tstar</span><span class="o">**</span><span class="mi">2</span>
<span class="n">Vstar</span>   <span class="o">=</span>  <span class="n">Lstar</span><span class="o">/</span><span class="n">Tstar</span>
<span class="n">Rhostar</span> <span class="o">=</span>  <span class="n">Mstar</span><span class="o">/</span><span class="n">Lstar</span><span class="o">**</span><span class="mi">3</span>
<span class="n">Estar</span>   <span class="o">=</span>  <span class="n">Mstar</span><span class="o">*</span><span class="p">(</span><span class="n">Vstar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Mustar</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">Lstar</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Tstar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Fstar</span>   <span class="o">=</span>  <span class="n">Astar</span><span class="o">*</span><span class="n">Mstar</span>
<span class="c1">#############################################################################</span>

<span class="n">mu</span>      <span class="o">=</span> <span class="mf">3.986012e14</span>      <span class="o">/</span><span class="n">Mustar</span>
<span class="n">Re</span>      <span class="o">=</span> <span class="mi">6378145</span>          <span class="o">/</span><span class="n">Lstar</span>
<span class="n">We</span>      <span class="o">=</span> <span class="mf">7.29211585e-5</span>    <span class="o">*</span><span class="n">Tstar</span>

<span class="n">RhoAir</span>  <span class="o">=</span> <span class="mf">1.225</span>        <span class="o">/</span><span class="n">Rhostar</span>
<span class="n">h_scale</span> <span class="o">=</span> <span class="mi">7200</span>         <span class="o">/</span><span class="n">Lstar</span>
<span class="n">g</span>       <span class="o">=</span> <span class="n">g0</span>           <span class="o">/</span><span class="n">Astar</span>


<span class="n">CD</span> <span class="o">=</span> <span class="mf">.5</span>
<span class="n">S</span>  <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>   <span class="o">/</span><span class="n">Lstar</span><span class="o">**</span><span class="mi">2</span>



<span class="n">TS</span> <span class="o">=</span> <span class="mi">628500</span>      <span class="o">/</span><span class="n">Fstar</span>
<span class="n">T1</span> <span class="o">=</span> <span class="mi">1083100</span>     <span class="o">/</span><span class="n">Fstar</span>
<span class="n">T2</span> <span class="o">=</span> <span class="mi">110094</span>      <span class="o">/</span><span class="n">Fstar</span>

<span class="n">IS</span> <span class="o">=</span> <span class="mf">283.33364</span>   <span class="o">/</span><span class="n">Tstar</span>
<span class="n">I1</span> <span class="o">=</span> <span class="mf">301.68</span>      <span class="o">/</span><span class="n">Tstar</span>
<span class="n">I2</span> <span class="o">=</span> <span class="mf">467.21</span>       <span class="o">/</span><span class="n">Tstar</span>

<span class="n">tS</span> <span class="o">=</span> <span class="mf">75.2</span>        <span class="o">/</span><span class="n">Tstar</span>
<span class="n">t1</span> <span class="o">=</span> <span class="mi">261</span>         <span class="o">/</span><span class="n">Tstar</span>
<span class="n">t2</span> <span class="o">=</span> <span class="mi">700</span>         <span class="o">/</span><span class="n">Tstar</span>


<span class="n">TMS</span> <span class="o">=</span> <span class="mi">19290</span>      <span class="o">/</span><span class="n">Mstar</span>
<span class="n">TM1</span> <span class="o">=</span> <span class="mi">104380</span>     <span class="o">/</span><span class="n">Mstar</span>
<span class="n">TM2</span> <span class="o">=</span> <span class="mi">19300</span>      <span class="o">/</span><span class="n">Mstar</span>
<span class="n">TMPay</span> <span class="o">=</span> <span class="mi">4164</span>     <span class="o">/</span><span class="n">Mstar</span>


<span class="n">PMS</span> <span class="o">=</span> <span class="mi">17010</span>     <span class="o">/</span><span class="n">Mstar</span>
<span class="n">PM1</span> <span class="o">=</span> <span class="mi">95550</span>     <span class="o">/</span><span class="n">Mstar</span>
<span class="n">PM2</span> <span class="o">=</span> <span class="mi">16820</span>     <span class="o">/</span><span class="n">Mstar</span>

<span class="n">SMS</span> <span class="o">=</span> <span class="n">TMS</span> <span class="o">-</span> <span class="n">PMS</span>
<span class="n">SM1</span> <span class="o">=</span> <span class="n">TM1</span> <span class="o">-</span> <span class="n">PM1</span>
<span class="n">SM2</span> <span class="o">=</span> <span class="n">TM2</span> <span class="o">-</span> <span class="n">PM2</span>

<span class="n">T_phase1</span> <span class="o">=</span> <span class="mi">6</span><span class="o">*</span><span class="n">TS</span> <span class="o">+</span> <span class="n">T1</span>
<span class="n">T_phase2</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">TS</span> <span class="o">+</span> <span class="n">T1</span>
<span class="n">T_phase3</span> <span class="o">=</span> <span class="n">T1</span>
<span class="n">T_phase4</span> <span class="o">=</span> <span class="n">T2</span>

<span class="n">mdot_phase1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">TS</span><span class="o">/</span><span class="n">IS</span> <span class="o">+</span> <span class="n">T1</span><span class="o">/</span><span class="n">I1</span><span class="p">)</span><span class="o">/</span><span class="n">g</span>
<span class="n">mdot_phase2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">TS</span><span class="o">/</span><span class="n">IS</span> <span class="o">+</span> <span class="n">T1</span><span class="o">/</span><span class="n">I1</span><span class="p">)</span><span class="o">/</span><span class="n">g</span>
<span class="n">mdot_phase3</span> <span class="o">=</span> <span class="n">T1</span><span class="o">/</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">I1</span><span class="p">)</span>
<span class="n">mdot_phase4</span> <span class="o">=</span> <span class="n">T2</span><span class="o">/</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">I2</span><span class="p">)</span>


<span class="n">tf_phase1</span> <span class="o">=</span> <span class="n">tS</span>
<span class="n">tf_phase2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tS</span>
<span class="n">tf_phase3</span> <span class="o">=</span> <span class="n">t1</span>
<span class="n">tf_phase4</span> <span class="o">=</span> <span class="n">t1</span><span class="o">+</span><span class="n">t2</span>

<span class="n">m0_phase1</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="n">TMS</span> <span class="o">+</span> <span class="n">TM1</span> <span class="o">+</span> <span class="n">TM2</span> <span class="o">+</span> <span class="n">TMPay</span>
<span class="n">mf_phase1</span> <span class="o">=</span> <span class="n">m0_phase1</span> <span class="o">-</span> <span class="mi">6</span><span class="o">*</span><span class="n">PMS</span> <span class="o">-</span> <span class="p">(</span><span class="n">tS</span><span class="o">/</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">PM1</span>

<span class="n">m0_phase2</span> <span class="o">=</span> <span class="n">mf_phase1</span> <span class="o">-</span> <span class="mi">6</span><span class="o">*</span><span class="n">SMS</span>
<span class="n">mf_phase2</span> <span class="o">=</span> <span class="n">m0_phase2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">PMS</span> <span class="o">-</span> <span class="p">(</span><span class="n">tS</span><span class="o">/</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">PM1</span>

<span class="n">m0_phase3</span> <span class="o">=</span> <span class="n">mf_phase2</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">SMS</span>
<span class="n">mf_phase3</span> <span class="o">=</span> <span class="n">m0_phase3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">tS</span><span class="o">/</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">PM1</span>

<span class="n">m0_phase4</span> <span class="o">=</span> <span class="n">mf_phase3</span> <span class="o">-</span> <span class="n">SM1</span>
<span class="n">mf_phase4</span> <span class="o">=</span> <span class="n">m0_phase4</span> <span class="o">-</span> <span class="n">PM2</span>


<span class="c1">#############################################################################</span>
<span class="k">class</span> <span class="nc">RocketODE</span><span class="p">(</span><span class="n">oc</span><span class="o">.</span><span class="n">ODEBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">mdot</span><span class="p">):</span>
        <span class="c1">####################################################</span>
        <span class="n">XtU</span>  <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">ODEArguments</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVec</span><span class="p">()</span><span class="o">.</span><span class="n">head3</span><span class="p">()</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVec</span><span class="p">()</span><span class="o">.</span><span class="n">segment3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">XVar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># We normalize the control direction in the dynamics so it doesnt have</span>
        <span class="c1"># to be done as a path constraint</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">XtU</span><span class="o">.</span><span class="n">UVec</span><span class="p">()</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>

        <span class="n">h</span>       <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">-</span> <span class="n">Re</span>
        <span class="n">rho</span>     <span class="o">=</span> <span class="n">RhoAir</span> <span class="o">*</span> <span class="n">vf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">h</span> <span class="o">/</span> <span class="n">h_scale</span><span class="p">)</span>
        <span class="n">Vr</span>      <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">We</span><span class="p">]))</span>

        <span class="c1">## We cant let let Vr be exactly 0, derivative of norm of 0 vector is NAN</span>
        <span class="c1">## Will handle this in inititial conditions</span>
        <span class="n">D</span>       <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">CD</span><span class="o">*</span><span class="n">S</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">Vr</span><span class="o">*</span><span class="n">Vr</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>

        <span class="n">Rdot</span>    <span class="o">=</span>  <span class="n">V</span>
        <span class="n">Vdot</span>    <span class="o">=</span>  <span class="p">(</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">R</span><span class="o">.</span><span class="n">normalized_power3</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span><span class="o">/</span><span class="n">m</span>

        <span class="n">ode</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">Rdot</span><span class="p">,</span><span class="n">Vdot</span><span class="p">,</span><span class="o">-</span><span class="n">mdot</span><span class="p">)</span>
        <span class="c1">####################################################</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">TargetOrbit</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">):</span>
    <span class="n">R</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)])</span>

    <span class="n">r</span>    <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="n">v</span>    <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="c1">#Angular momentum vector</span>
    <span class="n">hvec</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1">#Node vector</span>
    <span class="n">nvec</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">cross</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">hvec</span><span class="p">)</span>

    <span class="c1"># Energy</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="o">/</span><span class="n">r</span>

    <span class="c1"># Semi-major axis</span>
    <span class="n">a</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span><span class="o">/</span><span class="n">eps</span>

    <span class="n">evec</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">hvec</span><span class="p">)</span><span class="o">/</span><span class="n">mu</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
    <span class="c1">#Eccentrcity</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">evec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

    <span class="c1">#inclination</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">hvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1">#RAAN</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">nvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Quadrant Check</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="n">nvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span><span class="n">O</span><span class="p">)</span>

    <span class="c1"># Argument of periapse</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">nvec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evec</span><span class="o">.</span><span class="n">normalized</span><span class="p">()))</span>
    <span class="c1">#QuadrantCheck</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">vf</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="n">evec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">W</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">W</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">])</span>

<span class="c1">###############################################################################</span>

<span class="k">def</span> <span class="nf">Plot</span><span class="p">(</span><span class="n">Phase1</span><span class="p">,</span><span class="n">Phase2</span><span class="p">,</span><span class="n">Phase3</span><span class="p">,</span><span class="n">Phase4</span><span class="p">):</span>
    <span class="c1">############################################</span>

    <span class="k">def</span> <span class="nf">LatLongAlt</span><span class="p">(</span><span class="n">Traj</span><span class="p">):</span>
        <span class="n">LLs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">Traj</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">r</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

            <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="n">r</span><span class="p">))</span>

            <span class="n">long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
            <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span><span class="n">long</span><span class="o">+=</span><span class="mi">0</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span><span class="n">long</span><span class="o">+=</span><span class="mi">180</span>
            <span class="k">else</span><span class="p">:</span><span class="n">long</span><span class="o">-=</span><span class="mi">180</span>
            <span class="n">LLs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lat</span><span class="p">,</span><span class="n">long</span><span class="o">-</span><span class="mf">80.649</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">LLs</span>


    <span class="k">def</span> <span class="nf">AltVelMass</span><span class="p">(</span><span class="n">Traj</span><span class="p">):</span>
        <span class="n">Xs</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">Traj</span><span class="p">:</span>
            <span class="n">r</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">Re</span><span class="p">)</span><span class="o">*</span><span class="n">Lstar</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">*</span><span class="n">Vstar</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">Mstar</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">Tstar</span>
            <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">alt</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">t</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">LLs</span> <span class="o">=</span> <span class="n">LatLongAlt</span><span class="p">([</span><span class="n">Phase1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Phase2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Phase3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Phase4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Phase4</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">P1</span> <span class="o">=</span> <span class="n">AltVelMass</span><span class="p">(</span><span class="n">Phase1</span><span class="p">)</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">AltVelMass</span><span class="p">(</span><span class="n">Phase2</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="n">AltVelMass</span><span class="p">(</span><span class="n">Phase3</span><span class="p">)</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="n">AltVelMass</span><span class="p">(</span><span class="n">Phase4</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">321</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">323</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">325</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;h (km)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;v (km)/s&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;M (kg)&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t (s)&quot;</span><span class="p">)</span>

    <span class="n">PS</span> <span class="o">=</span> <span class="p">[</span><span class="n">P1</span><span class="p">,</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">,</span><span class="n">P4</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">P</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PS</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Stage </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>



    <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;lcc&#39;</span><span class="p">,</span>
                <span class="n">lat_1</span><span class="o">=</span><span class="mf">45.</span><span class="p">,</span><span class="n">lat_2</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span><span class="n">lat_0</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">lon_0</span><span class="o">=-</span><span class="mf">65.</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">9000000</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">9000000</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">lon1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">LLs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lat1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">LLs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lon2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">LLs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lat2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">LLs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">m</span><span class="o">.</span><span class="n">drawgreatcircle</span><span class="p">(</span><span class="n">lon1</span><span class="o">=</span><span class="n">lon1</span><span class="p">,</span><span class="n">lat1</span><span class="o">=</span><span class="n">lat1</span><span class="p">,</span><span class="n">lon2</span><span class="o">=</span><span class="n">lon2</span><span class="p">,</span><span class="n">lat2</span><span class="o">=</span><span class="n">lat2</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="c1">#m.bluemarble()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">shadedrelief</span><span class="p">()</span>

    <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span><span class="mf">91.</span><span class="p">,</span><span class="mf">30.</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">181.</span><span class="p">,</span><span class="mf">60.</span><span class="p">))</span>
    <span class="c1">#m.drawmapboundary(fill_color=&#39;aqua&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Ground Track&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###############################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">ast</span><span class="o">.</span><span class="n">SoftwareInfo</span><span class="p">()</span>


    <span class="c1"># Target orbital elements</span>
    <span class="n">at</span>     <span class="o">=</span> <span class="mi">24361140</span> <span class="o">/</span><span class="n">Lstar</span>
    <span class="n">et</span>     <span class="o">=</span> <span class="mf">.7308</span>
    <span class="n">Ot</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">269.8</span><span class="p">)</span>
    <span class="n">Wt</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">130.5</span><span class="p">)</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">28.5</span><span class="p">)</span>


    <span class="n">y0</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">istart</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">istart</span><span class="p">)])</span><span class="o">*</span><span class="n">Re</span>
    <span class="n">y0</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">We</span><span class="p">]))</span>
    <span class="n">y0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">+=</span> <span class="mf">0.00001</span><span class="o">/</span><span class="n">Vstar</span>  <span class="c1"># cant be exactly zero,our drag equation&#39;s derivative would NAN !!!</span>


    <span class="c1">## MF is the only magic number in the script, just trying to find</span>
    <span class="c1">## a mean anomaly such that the terminal state on the orbit is downrange</span>
    <span class="c1">## eastward from KSC in and doesnt pass through earth when LERPed from KSC</span>
    <span class="n">MF</span>   <span class="o">=-</span><span class="mf">.05</span>
    <span class="n">OEF</span>  <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">MF</span><span class="p">]</span>
    <span class="n">yf</span>   <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Astro</span><span class="o">.</span><span class="n">classic_to_cartesian</span><span class="p">(</span><span class="n">OEF</span><span class="p">,</span><span class="n">mu</span><span class="p">)</span>

    <span class="n">ts</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tf_phase4</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">IG1</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">IG2</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">IG3</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">IG4</span> <span class="o">=</span><span class="p">[]</span>


    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">yf</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="n">t</span>
        <span class="n">X</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase1</span><span class="p">):</span>
            <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase1</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase1</span><span class="o">-</span><span class="n">m0_phase1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tf_phase1</span><span class="p">)</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
            <span class="n">IG1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase2</span><span class="p">):</span>
            <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase2</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase2</span><span class="o">-</span><span class="n">m0_phase2</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase2</span> <span class="o">-</span> <span class="n">tf_phase1</span><span class="p">))</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
            <span class="n">IG2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase3</span><span class="p">):</span>
            <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase3</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase3</span><span class="o">-</span><span class="n">m0_phase3</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase3</span> <span class="o">-</span> <span class="n">tf_phase2</span><span class="p">))</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
            <span class="n">IG3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tf_phase4</span><span class="p">):</span>
            <span class="n">m</span><span class="o">=</span> <span class="n">m0_phase4</span> <span class="o">+</span> <span class="p">(</span><span class="n">mf_phase4</span><span class="o">-</span><span class="n">m0_phase4</span><span class="p">)</span><span class="o">*</span><span class="p">((</span> <span class="n">t</span><span class="o">-</span><span class="n">tf_phase3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf_phase4</span> <span class="o">-</span> <span class="n">tf_phase3</span><span class="p">))</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
            <span class="n">IG4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>



    <span class="n">ode1</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase1</span><span class="p">,</span><span class="n">mdot_phase1</span><span class="p">)</span>
    <span class="n">ode2</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase2</span><span class="p">,</span><span class="n">mdot_phase2</span><span class="p">)</span>
    <span class="n">ode3</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase3</span><span class="p">,</span><span class="n">mdot_phase3</span><span class="p">)</span>
    <span class="n">ode4</span> <span class="o">=</span> <span class="n">RocketODE</span><span class="p">(</span><span class="n">T_phase4</span><span class="p">,</span><span class="n">mdot_phase4</span><span class="p">)</span>

    <span class="n">tmode</span> <span class="o">=</span> <span class="s2">&quot;LGL3&quot;</span>
    <span class="n">cmode</span> <span class="o">=</span> <span class="s2">&quot;HighestOrderSpline&quot;</span>

    <span class="n">nsegs1</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">nsegs2</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">nsegs3</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">nsegs4</span> <span class="o">=</span> <span class="mi">40</span>

    <span class="c1">#########################################</span>
    <span class="n">phase1</span> <span class="o">=</span> <span class="n">ode1</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG1</span><span class="p">,</span><span class="n">nsegs1</span><span class="p">)</span>
    <span class="n">phase1</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

    <span class="c1">## Thrust direction is normalized in dynamics, so we dont</span>
    <span class="c1">## have to enforce norm of 1 on controls. For good measure,</span>
    <span class="c1">## we do bound the maginitude to prevent it from becoming too large or small</span>
    <span class="n">phase1</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">phase1</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">IG1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>

    <span class="c1">#Dont want our bound to interfere with initial condition which starts at Re</span>
    <span class="c1">#so i relax the Earth radius constraint slightly here</span>
    <span class="n">phase1</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="o">*</span><span class="mf">.999999</span><span class="p">)</span>
    <span class="n">phase1</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,[</span><span class="mi">7</span><span class="p">],[</span><span class="n">tf_phase1</span><span class="p">])</span>

    <span class="c1">#########################################</span>
    <span class="n">phase2</span> <span class="o">=</span> <span class="n">ode2</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG2</span><span class="p">,</span><span class="n">nsegs2</span><span class="p">)</span>
    <span class="n">phase2</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

    <span class="n">phase2</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
    <span class="n">phase2</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="c1">## Fixing initial mass and final time on first 3 phases.</span>
    <span class="c1">## Since the engine cant be throttled, constraining final mass</span>
    <span class="c1">## as well would be redundant and overconstrained</span>
    <span class="n">phase2</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase2</span><span class="p">])</span>
    <span class="n">phase2</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">,[</span><span class="n">tf_phase2</span><span class="p">])</span>

    <span class="c1">#########################################</span>
    <span class="n">phase3</span> <span class="o">=</span> <span class="n">ode3</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG3</span><span class="p">,</span><span class="n">nsegs3</span><span class="p">)</span>
    <span class="n">phase3</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

    <span class="n">phase3</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
    <span class="n">phase3</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">phase3</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase3</span><span class="p">])</span>
    <span class="n">phase3</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">,[</span><span class="n">tf_phase3</span><span class="p">])</span>

    <span class="c1">#########################################</span>
    <span class="n">phase4</span> <span class="o">=</span> <span class="n">ode4</span><span class="o">.</span><span class="n">phase</span><span class="p">(</span><span class="n">tmode</span><span class="p">,</span><span class="n">IG4</span><span class="p">,</span><span class="n">nsegs4</span><span class="p">)</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">setControlMode</span><span class="p">(</span><span class="n">cmode</span><span class="p">)</span>

    <span class="n">phase4</span><span class="o">.</span><span class="n">addLowerNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">Re</span><span class="p">)</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">addLUNormBound</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="mf">.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">addBoundaryValue</span><span class="p">(</span><span class="s2">&quot;Front&quot;</span><span class="p">,[</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="n">m0_phase4</span><span class="p">])</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">addUpperVarBound</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">tf_phase4</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">addEqualCon</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="n">TargetOrbit</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">et</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">Ot</span><span class="p">,</span><span class="n">Wt</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="c1"># Maximize final mass</span>
    <span class="n">phase4</span><span class="o">.</span><span class="n">addValueObjective</span><span class="p">(</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1">#########################################</span>

    <span class="n">ocp</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">OptimalControlProblem</span><span class="p">()</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase1</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase2</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase3</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phase4</span><span class="p">)</span>

    <span class="c1">## All phases continuous in everything but mass (var 6)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">addForwardLinkEqualCon</span><span class="p">(</span><span class="n">phase1</span><span class="p">,</span><span class="n">phase4</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>


    <span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_OptLSMode</span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_SoeLSMode</span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_MaxLSIters</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ocp</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">set_PrintLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ocp</span><span class="o">.</span><span class="n">solve_optimize</span><span class="p">()</span>
    <span class="c1">#########################################</span>


    <span class="n">Phase1Traj</span> <span class="o">=</span> <span class="n">phase1</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>  <span class="c1"># or ocp.Phase(i).returnTraj()</span>
    <span class="n">Phase2Traj</span> <span class="o">=</span> <span class="n">phase2</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>
    <span class="n">Phase3Traj</span> <span class="o">=</span> <span class="n">phase3</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>
    <span class="n">Phase4Traj</span> <span class="o">=</span> <span class="n">phase4</span><span class="o">.</span><span class="n">returnTraj</span><span class="p">()</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final Mass = &quot;</span><span class="p">,</span><span class="n">Phase4Traj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">Mstar</span><span class="p">,</span><span class="s1">&#39; kg&#39;</span><span class="p">)</span>


    <span class="n">Plot</span><span class="p">(</span><span class="n">Phase1Traj</span><span class="p">,</span><span class="n">Phase2Traj</span><span class="p">,</span><span class="n">Phase3Traj</span><span class="p">,</span><span class="n">Phase4Traj</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="ReentryExample.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Space Shuttle Reentry</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="examples.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Examples</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022-2023, UA ASRL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Delta 3 Multi-phase GTO Transfer</a><ul>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#full-code">Full Code</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>